local Players         = game:GetService("Players")
local HttpService     = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local LocalPlayer     = Players.LocalPlayer

local http_request_impl =
    (syn and syn.request)
    or (typeof(http_request) == "function" and http_request)
    or (typeof(request) == "function" and request)
    or (http and http.request)

if not http_request_impl then
    warn("‚ùå Kh√¥ng c√≥ HTTP.")
    return
end

local POLL_INTERVAL = 3.0
local RETRY_INTERVAL = 3.0
local AFTER_TP_WAIT = 0.4
local STARTDELAY = 3.0

local function getInstanceName()
    local uid = tostring(LocalPlayer.UserId or 0)
    return LocalPlayer.Name .. "" .. uid:sub(-2)
end

local INSTANCE = getInstanceName()
local HTTP_URL = nil

local function detectActivePort()
    local found = false
    for p = 8080, 8095 do
        task.spawn(function()
            if found or HTTP_URL then return end
            local statusUrl = ("http://127.0.0.1:%d/status"):format(p)
            local ok, res = pcall(function()
                return http_request_impl({ Url = statusUrl, Method = "GET", Timeout = 0.3 })
            end)
            if not ok or not res then return end
            if res.StatusCode ~= 200 or not res.Body or #res.Body == 0 then return end
            local ok_json = pcall(function() HttpService:JSONDecode(res.Body) end)
            if not ok_json then return end
            if not found and not HTTP_URL then
                found = true
                HTTP_URL = ("http://127.0.0.1:%d/next?instance=%s"):format(p, INSTANCE)
                print("[DK AutoJoin] ‚úì Found port", p)
            end
        end)
    end

    local t0 = tick()
    while not HTTP_URL and (tick() - t0) < 3 do task.wait(0.01) end
    if not HTTP_URL then
        HTTP_URL = ("http://127.0.0.1:8080/next?instance=%s%22):format(INSTANCE)
        warn("[DK AutoJoin] ‚ö† Kh√¥ng detect ƒë∆∞·ª£c port, d√πng fallback 8080.")
    end
end

detectActivePort()
print("[DK AutoJoin] START at", HTTP_URL)

local recentSet = {}
local function pushRecent(jobId) recentSet[jobId] = true end

do
    local h = 0
    for i = 1, #INSTANCE do
        h = (h * 131 + INSTANCE:byte(i)) % 997
    end
    local offset = (h % 300) / 1000
    task.wait(0.3 + offset)
end

print(string.format("[DK AutoJoin] ‚è± Ch·ªù %.1fs r·ªìi m·ªõi b·∫Øt ƒë·∫ßu nh·∫≠n job t·ª´ port...", START_DELAY))
task.wait(START_DELAY)

task.spawn(function()
    while true do
        local ok_req, response = pcall(function()
            return http_request_impl({ Url = HTTP_URL, Method = "GET" })
        end)
        local jobFound = false
        if ok_req and response and response.Body then
            local ok_json, data = pcall(function() return HttpService:JSONDecode(response.Body) end)
            if ok_json and type(data) == "table" then
                local jobId = tostring(data.jobId or "")
                local placeId = tonumber(data.placeId) or game.PlaceId
                if jobId ~= "" and jobId ~= "null" and not recentSet[jobId] then
                    jobFound = true
                    pushRecent(jobId)
                    print("üü¢ JOIN:", jobId)
                    pcall(function() TeleportService:TeleportToPlaceInstance(placeId, jobId, LocalPlayer) end)
                    task.wait(AFTER_TP_WAIT)
                end
            end
        end
        if jobFound then task.wait(POLL_INTERVAL) else task.wait(RETRY_INTERVAL) end
    end
end)
